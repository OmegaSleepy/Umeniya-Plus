<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Умения+</title>
    <link rel="stylesheet" href="/api/style">
</head>
<body>

<header>
    <div class="header-container">
        <a href="/" class="logo">Умения+</a>
        <a href="/create" class="btn-create">+ Създай Пост</a>
    </div>
</header>

<div id="search" class="search">
    <label for="category">Категория</label>
    <select id="category" name="category">
    </select>

    <label for="order-by">Подреди по</label>
    <select id="order-by" name="order-by">
        <option value="normal">По подразбиране</option>
        <option value="oldest-first">Най - стари първо</option>
        <option value="newest-first">Най - нови първо</option>
    </select>

    <br>

    <label for="blog-name">Име</label>
    <input type="text" id="blog-name">
    <br>

    <button id="show">
        Потърси
    </button>

    <button id="clear">
        Изчисти филтрите
    </button>
</div>

<div id="holder">
</div>

<script>

    async function loadCategories() {
        try {
            const response = await fetch("/api/blog/tags");
            if (!response.ok) throw new Error("Failed to fetch tags");
            const tags = await response.json();
            const select = document.getElementById("category");
            select.innerHTML = "";
            tags.forEach(tag => {
                const option = document.createElement("option");
                option.value = tag;
                option.textContent = tag;
                select.appendChild(option);
            });
            select.selectedIndex = select.options.length-1;
        } catch (err) {
            console.error("Error loading categories:", err);
        }
    }

    function createElement(tag, text, classname){
        const element = document.createElement(tag);
        element.innerHTML = text;
        if(classname){element.classList.add(classname);}
        return element;
    }

    document.getElementById("show").addEventListener("click", function(){
        const category = document.getElementById("category").value
        const name = document.getElementById("blog-name").value
        const orderBy = document.getElementById("order-by").value;

        const parameters = new URLSearchParams({
            name: name,
            category: category,
            order: orderBy
        });
        loadStuff(`/api/blog/get-filtered-view/?${parameters.toString()}`)
    })

    document.getElementById("clear").addEventListener("click", function (){
        const category_select = document.getElementById("category");
        category_select.selectedIndex = category_select.options.length-1;
        document.getElementById("blog-name").value = '';
        loadStuff(`/api/blog/get-filtered-view/`)
    })

    async function loadStuff(url) {
        try {
            const response = await fetch(url);
            const select = document.getElementById("holder");
            const data = await response.json();

            select.replaceChildren();

            data.forEach(element => {
                const blog = document.createElement("div");
                blog.classList.add("blog");

                blog.style.cursor = "pointer";
                blog.onclick = () => {
                    window.location.href = `/blog/${element.id}`;
                };

                blog.append(
                    createElement("h1", element.title,"blog-title"),
                    createElement("p", element.tag,"blog-tag"),
                    createElement("p", element.excerpt,"blog-excerpt")
                )
                select.append(blog);
            })
        } catch (err) {
            console.error("Failed to load blogs:", err);
        }
    }

    loadStuff("/api/blog/get-filtered-view/");
    loadCategories();
</script>
</body>
</html>