<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–£–º–µ–Ω–∏—è+</title>
    <link rel="stylesheet" href="/api/style">
</head>
<body>

<header>
    <div class="header-container">
        <a href="/" class="logo">–£–º–µ–Ω–∏—è+</a>
        <div class="header-actions">
            <button id="toggle-search-btn" class="btn-create" style="background-color: var(--text-light); margin-right: 10px;">
                üîç –§–∏–ª—Ç—Ä–∏
            </button>
            <a href="/create" class="btn-create">+ –°—ä–∑–¥–∞–π –ü–æ—Å—Ç</a>
        </div>
    </div>
</header>

<div id="search" class="search">
    <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
    <select id="category" name="category">
    </select>

    <label for="order-by">–ü–æ–¥—Ä–µ–¥–∏ –ø–æ</label>
    <select id="order-by" name="order-by">
        <option value="normal">–ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ</option>
        <option value="oldest-first">–ù–∞–π - —Å—Ç–∞—Ä–∏ –ø—ä—Ä–≤–æ</option>
        <option value="newest-first">–ù–∞–π - –Ω–æ–≤–∏ –ø—ä—Ä–≤–æ</option>
    </select>

    <br>

    <label for="blog-name">–ò–º–µ</label>
    <input type="text" id="blog-name">
    <br>

    <button id="show" class="fancy-button">
        –ü–æ—Ç—ä—Ä—Å–∏
    </button>

    <button id="clear" class="fancy-button">
        –ò–∑—á–∏—Å—Ç–∏ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ
    </button>
</div>

<div id="pagination-top" class="pagination-wrapper"></div>

<div id="holder"></div>

<div id="pagination-bottom" class="pagination-wrapper"></div>

<script>
    let currentPage = 0;

    const searchSection = document.getElementById("search");
    const toggleBtn = document.getElementById("toggle-search-btn");

    searchSection.classList.add("hidden");


    toggleBtn.addEventListener("click", function() {
        const isHidden = searchSection.classList.toggle("hidden");
        this.style.backgroundColor = !isHidden ? "var(--primary-color)" : "var(--text-light)";
    });

    document.getElementById("show").addEventListener("click", function(){
        currentPage = 0;
        triggerFetch();
    });

    document.getElementById("clear").addEventListener("click", function (){
        const category_select = document.getElementById("category");
        category_select.selectedIndex = category_select.options.length - 1;
        document.getElementById("blog-name").value = '';
        currentPage = 0;
        triggerFetch();
    });


    async function loadCategories() {
        try {
            const response = await fetch("/api/blog/tags");
            if (!response.ok) throw new Error("Failed to fetch tags");
            const tags = await response.json();
            const select = document.getElementById("category");
            select.innerHTML = "";
            tags.forEach(tag => {
                const option = document.createElement("option");
                option.value = tag;
                option.textContent = tag;
                select.appendChild(option);
            });
            select.selectedIndex = select.options.length - 1;
        } catch (err) {
            console.error("Error loading categories:", err);
        }
    }

    function createElement(tag, text, classname){
        const element = document.createElement(tag);
        element.innerHTML = text;
        if(classname){element.classList.add(classname);}
        return element;
    }

    function triggerFetch() {
        const category = document.getElementById("category").value;
        const name = document.getElementById("blog-name").value;
        const orderBy = document.getElementById("order-by").value;

        const parameters = new URLSearchParams({
            name: name,
            category: category,
            order: orderBy,
            page: currentPage
        });
        loadStuff(`/api/blog/get-filtered-view/?${parameters.toString()}`);
    }

    async function loadStuff(url) {
        try {
            const response = await fetch(url);
            const holder = document.getElementById("holder");
            const data = await response.json();

            holder.replaceChildren();

            data.forEach(element => {
                const blog = document.createElement("div");
                blog.classList.add("blog");
                blog.style.cursor = "pointer";
                blog.onclick = () => { window.location.href = `/blog/${element.id}`; };

                blog.append(
                    createElement("h1", element.title, "blog-title"),
                    createElement("p", element.tag, "blog-tag"),
                    createElement("p", element.excerpt, "blog-excerpt")
                );
                holder.append(blog);
            });

            renderPagination(data.length);

        } catch (err) {
            console.error("Failed to load blogs:", err);
        }
    }

    function renderPagination(itemsCount) {
        const containers = [
            document.getElementById("pagination-top"),
            document.getElementById("pagination-bottom")
        ];

        containers.forEach(container => {
            if (!container) return;
            container.innerHTML = "";

            const prevBtn = document.createElement("button");
            prevBtn.textContent = "‚Üê –ù–∞–∑–∞–¥";
            prevBtn.classList.add("nav-btn");
            prevBtn.disabled = currentPage === 0;
            prevBtn.onclick = () => {
                currentPage--;
                triggerFetch();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const indicator = document.createElement("span");
            indicator.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage + 1}`;
            indicator.classList.add("current-page-display");

            const nextBtn = document.createElement("button");
            nextBtn.textContent = "–ù–∞–ø—Ä–µ–¥ ‚Üí";
            nextBtn.classList.add("nav-btn");
            nextBtn.disabled = itemsCount < 15;
            nextBtn.onclick = () => {
                currentPage++;
                triggerFetch();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            container.append(prevBtn, indicator, nextBtn);
        });
    }

    //init
    loadStuff("/api/blog/get-filtered-view/?page=0");
    loadCategories();
</script>
</body>
</html>