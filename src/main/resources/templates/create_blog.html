<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Създай нов пост в Умения+</title>
    <link rel="stylesheet" href="/api/style">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

<header>
    <div class="header-container">
        <a href="/" class="logo">Skills+</a>
        <a href="/home" class="btn-create">Разгледай Постове</a>
    </div>
</header>

<div class="editor-wrapper" id="mainWrapper">
    <div class="form-container" id="formSide">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">Създай Нов Пост</h2>
            <button type="button" id="togglePreview" class="btn-toggle">Предварителен Преглед</button>
        </div>

        <form id="blogForm">
            <div class="form-group">
                <label for="title">Заглавие</label>
                <input type="text" id="title" name="title" placeholder="Въведи интригуващо заглавие..." required>
            </div>

            <div class="form-group">
                <label for="category">Категория</label>
                <select id="category" name="category">
                </select>
            </div>

            <div class="form-group">
                <label for="excerpt">Кратко описание</label>
                <input type="text" id="excerpt" name="excerpt" placeholder="Както описание на съдържанието на поста">
            </div>

            <div class="form-group">

                <a href="/help/markdown-info">
                    <label for="content">Съдържание (Markdown)</label>
                </a>
                <textarea id="content" name="content" placeholder="Въведи тялото на вашата статия тук..." required></textarea>
            </div>

            <button type="submit" class="btn-submit">Публикувай</button>
        </form>
    </div>

    <div id="preview-panel" class="article-container" style="margin-top: 0; display: none;">
        <span class="post-tag" id="preview-tag">Категория</span>
        <h1 class="post-title" id="preview-title">Преглед на заглавието</h1>
        <div class="post-excerpt" id="preview-excerpt">Краткото описание ще се появи тук...</div>
        <hr>
        <div id="markdown-body" class="post-content"></div>
    </div>
</div>

<script>

    const contentInput = document.getElementById('content');
    const titleInput = document.getElementById('title');
    const excerptInput = document.getElementById('excerpt');
    const categoryInput = document.getElementById('category');
    const previewPanel = document.getElementById('preview-panel');
    const formSide = document.getElementById('formSide');
    const toggleBtn = document.getElementById('togglePreview');
    const mainWrapper = document.getElementById('mainWrapper');

    // Live Update Function
    function updatePreview() {
        document.getElementById('preview-title').textContent = titleInput.value || "Преглед на заглавието";
        document.getElementById('preview-excerpt').textContent = excerptInput.value || "Краткото описание ще се появи тук...";
        document.getElementById('preview-tag').textContent = categoryInput.value || "Категория";

        const rawValue = contentInput.value;

        document.getElementById('markdown-body').innerHTML = marked.parse(rawValue);
    }

    // Toggle Preview Panel
    toggleBtn.addEventListener('click', () => {
        const isShowing = previewPanel.style.display === 'block';

        if (isShowing) {
            previewPanel.style.display = 'none';
            formSide.classList.remove('split-mode');

            mainWrapper.style.display = 'block';
            mainWrapper.style.maxWidth = '600px'; // Keep form width tight
            toggleBtn.textContent = "Show Preview";
        } else {
            previewPanel.style.display = 'block';
            formSide.classList.add('split-mode');

            mainWrapper.style.display = 'flex';
            mainWrapper.style.maxWidth = '1400px'; // Expand to fit both
            toggleBtn.textContent = "Hide Preview";
            updatePreview();
        }
    });

    [contentInput, titleInput, excerptInput, categoryInput].forEach(el => {
        el.addEventListener('input', updatePreview);
    });

    async function loadCategories() {
        try {
            const response = await fetch("/api/blog/tags");
            if (!response.ok) throw new Error("Failed to fetch tags");
            const tags = await response.json();
            const select = document.getElementById("category");
            select.innerHTML = "";
            tags.forEach(tag => {
                const option = document.createElement("option");
                option.value = tag;
                option.textContent = tag;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Error loading categories:", err);
        }
    }

    document.getElementById("blogForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const data = {
            title: titleInput.value,
            category: categoryInput.value,
            excerpt: excerptInput.value,
            content: contentInput.value
        };

        try {
            const response = await fetch("/api/blog/content", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error("Network response was not OK");
            alert("Blog post submitted successfully!");
            document.getElementById("blogForm").reset();
            updatePreview();
        } catch (err) {
            console.error("Error submitting blog post:", err);
            alert("Failed to submit blog post.");
        }
    });

    loadCategories();

    loadCategories();
</script>
</body>


</html>